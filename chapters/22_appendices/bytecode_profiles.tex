\chapter{Bytecode profiles}
\label{chap:bytecode-profiles}

\begin{code}
    \begin{minted}[fontsize=\footnotesize]{text}
//// Trace of `Extensibility.time_trait_check` :

// == microbenchmarks:176 `time_trait_check` ===
// >>> assert Extensibility.OP_WITH_REGION.has_trait(Extensibility.TRAIT_4)
204         0   LOAD_GLOBAL          0   (Extensibility)                                            // 17   ns
            2   LOAD_ATTR            1   (OP_WITH_REGION)                                           // 18   ns
            4   LOAD_METHOD          2   (has_trait)                                                // 18   ns
            6   LOAD_GLOBAL          0   (Extensibility)                                            // 17   ns
            8   LOAD_ATTR            3   (TRAIT_4)                                                  // 18   ns
            10  CALL_METHOD          1   ()                                                         // 54   ns

    // =========== core:1192 `has_trait` ===========
    // >>> from xdsl.dialects.builtin import UnregisteredOp
    1204         0   LOAD_CONST           1   (0)                                                   // 26   ns
                2   LOAD_CONST           2   (('UnregisteredOp',))                                  // 25   ns
                4   IMPORT_NAME          0   (xdsl.dialects.builtin)                                // 72   ns
                6   IMPORT_FROM          1   (UnregisteredOp)                                       // 28   ns
                8   STORE_FAST           3   (UnregisteredOp)                                       // 23   ns
                10  POP_TOP                  ()                                                     // 21   ns
    // >>> if issubclass(cls, UnregisteredOp):
    1206         12  LOAD_GLOBAL          2   (issubclass)                                          // 21   ns
                14  LOAD_FAST            0   (cls)                                                  // 21   ns
                16  LOAD_FAST            3   (UnregisteredOp)                                       // 19   ns
                18  CALL_FUNCTION        2   ()                                                     // 46   ns

        // ======== abc:121 `__subclasscheck__` ========
        // >>> return _abc_subclasscheck(cls, subclass)
        123         0   LOAD_GLOBAL          0   (_abc_subclasscheck)                               // 19   ns
                    2   LOAD_FAST            0   (cls)                                              // 18   ns
                    4   LOAD_FAST            1   (subclass)                                         // 17   ns
                    6   CALL_FUNCTION        2   ()                                                 // 26   ns
                    8   RETURN_VALUE             ()                                                 // 44   ns
        // =============================================

                20  POP_JUMP_IF_FALSE    13  (to 26)                                                // 22   ns
    // >>> return cls.get_trait(trait) is not None
    1209     >>  26  LOAD_FAST            0   (cls)                                                 // 21   ns
                28  LOAD_METHOD          3   (get_trait)                                            // 23   ns
                30  LOAD_FAST            1   (trait)                                                // 21   ns
                32  CALL_METHOD          1   ()                                                     // 52   ns

        // =========== core:1211 `get_trait` ===========
        // >>> if isinstance(trait, type):
        1216         0   LOAD_GLOBAL          0   (isinstance)                                      // 24   ns
                    2   LOAD_FAST            1   (trait)                                            // 23   ns
                    4   LOAD_GLOBAL          1   (type)                                             // 25   ns
                    6   CALL_FUNCTION        2   ()                                                 // 25   ns
                    8   POP_JUMP_IF_FALSE    27  (to 54)                                            // 23   ns
        // >>> for t in cls.traits:
        1217         10  LOAD_FAST            0   (cls)                                             // 22   ns
                    12  LOAD_ATTR            2   (traits)                                           // 24   ns
                    14  GET_ITER                 ()                                                 // 43   ns

            // ============ core:758 `__iter__` ============
            // >>> return iter(self.traits)
            759         0   LOAD_GLOBAL          0   (iter)                                         // 17   ns
                        2   LOAD_FAST            0   (self)                                         // 16   ns
                        4   LOAD_ATTR            1   (traits)                                       // 38   ns

                // ============= core:747 `traits` =============
                // >>> if callable(self._traits):
                750         0   LOAD_GLOBAL          0   (callable)                                 // 17   ns
                            2   LOAD_FAST            0   (self)                                     // 15   ns
                            4   LOAD_ATTR            1   (_traits)                                  // 17   ns
                            6   CALL_FUNCTION        1   ()                                         // 18   ns
                            8   POP_JUMP_IF_FALSE    12  (to 24)                                    // 17   ns
                // >>> return self._traits
                752     >>  24  LOAD_FAST            0   (self)                                     // 16   ns
                            26  LOAD_ATTR            1   (_traits)                                  // 16   ns
                            28  RETURN_VALUE             ()                                         // 38   ns
                // =============================================

                        6   CALL_FUNCTION        1   ()                                             // 22   ns
                        8   RETURN_VALUE             ()                                             // 42   ns
            // =============================================

                >>  16  FOR_ITER             16  (to 50)                                            // 25   ns
                    18  STORE_FAST           2   (t)                                                // 22   ns
        // >>> if isinstance(t, cast(type[OpTraitInvT], trait)):
        1218         20  LOAD_GLOBAL          0   (isinstance)                                      // 21   ns
                    22  LOAD_FAST            2   (t)                                                // 21   ns
                    24  LOAD_GLOBAL          3   (cast)                                             // 21   ns
                    26  LOAD_GLOBAL          1   (type)                                             // 19   ns
                    28  LOAD_GLOBAL          4   (OpTraitInvT)                                      // 18   ns
                    30  BINARY_SUBSCR            ()                                                 // 22   ns
                    32  LOAD_FAST            1   (trait)                                            // 19   ns
                    34  CALL_FUNCTION        2   ()                                                 // 41   ns

            // ============ typing:1737 `cast` =============
            // >>> return val
            1745         0   LOAD_FAST            1   (val)                                         // 18   ns
                        2   RETURN_VALUE             ()                                             // 43   ns
            // =============================================

                    36  CALL_FUNCTION        2   ()                                                 // 23   ns
                    38  POP_JUMP_IF_FALSE    24  (to 48)                                            // 20   ns
        1218     >>  48  JUMP_ABSOLUTE        8   (to 16)                                           // 20   ns
        // >>> for t in cls.traits:
                >>  16  FOR_ITER             16  (to 50)                                            // 19   ns
                    18  STORE_FAST           2   (t)                                                // 19   ns
        // >>> if isinstance(t, cast(type[OpTraitInvT], trait)):
        1218         20  LOAD_GLOBAL          0   (isinstance)                                      // 19   ns
                    22  LOAD_FAST            2   (t)                                                // 19   ns
                    24  LOAD_GLOBAL          3   (cast)                                             // 19   ns
                    26  LOAD_GLOBAL          1   (type)                                             // 18   ns
                    28  LOAD_GLOBAL          4   (OpTraitInvT)                                      // 18   ns
                    30  BINARY_SUBSCR            ()                                                 // 21   ns
                    32  LOAD_FAST            1   (trait)                                            // 19   ns
                    34  CALL_FUNCTION        2   ()                                                 // 40   ns

            // ============ typing:1737 `cast` =============
            // >>> return val
            1745         0   LOAD_FAST            1   (val)                                         // 18   ns
                        2   RETURN_VALUE             ()                                             // 43   ns
            // =============================================

                    36  CALL_FUNCTION        2   ()                                                 // 21   ns
                    38  POP_JUMP_IF_FALSE    24  (to 48)                                            // 20   ns
        // >>> return t
        1219         40  LOAD_FAST            2   (t)                                               // 19   ns
                    42  ROT_TWO                  ()                                                 // 19   ns
                    44  POP_TOP                  ()                                                 // 20   ns
                    46  RETURN_VALUE             ()                                                 // 47   ns
        // =============================================

                34  LOAD_CONST           3   (None)                                                 // 21   ns
                36  IS_OP                1   ()                                                     // 21   ns
                38  RETURN_VALUE             ()                                                     // 47   ns
    // =============================================

            12  POP_JUMP_IF_TRUE     9   (to 18)                                                    // 16   ns
        >>  18  LOAD_CONST           1   (None)                                                     // 16   ns
            20  RETURN_VALUE             ()                                                         // 39   ns
// =============================================
    \end{minted}
    \caption{Bytecode profile trace of the original implementation of \mintinline{python}{has_trait}.}
    \label{listing:bytecode-profiles-hastrait-original}
\end{code}

\vspace{2em}

\begin{code}
    \begin{minted}[fontsize=\footnotesize]{text}
//// Trace of `Extensibility.time_trait_check_optimised` :

// == microbenchmarks:206 `time_trait_check_optimised` ==
// >>> has_trait = False
208         0   LOAD_CONST           1   (False)                                                    // 14   ns
            2   STORE_FAST           1   (has_trait)                                                // 14   ns
// >>> for t in Extensibility.OP_WITH_REGION.traits._traits:
209         4   LOAD_GLOBAL          0   (Extensibility)                                            // 13   ns
            6   LOAD_ATTR            1   (OP_WITH_REGION)                                           // 13   ns
            8   LOAD_ATTR            2   (traits)                                                   // 13   ns
            10  LOAD_ATTR            3   (_traits)                                                  // 13   ns
            12  GET_ITER                 ()                                                         // 13   ns
        >>  14  FOR_ITER             12  (to 40)                                                    // 13   ns
            16  STORE_FAST           2   (t)                                                        // 11   ns
// >>> if isinstance(t, Extensibility.TRAIT_4):
210         18  LOAD_GLOBAL          4   (isinstance)                                               // 11   ns
            20  LOAD_FAST            2   (t)                                                        // 11   ns
            22  LOAD_GLOBAL          0   (Extensibility)                                            // 11   ns
            24  LOAD_ATTR            5   (TRAIT_4)                                                  // 11   ns
            26  CALL_FUNCTION        2   ()                                                         // 12   ns
            28  POP_JUMP_IF_FALSE    19  (to 38)                                                    // 11   ns
210     >>  38  JUMP_ABSOLUTE        7   (to 14)                                                    // 11   ns
// >>> for t in Extensibility.OP_WITH_REGION.traits._traits:
        >>  14  FOR_ITER             12  (to 40)                                                    // 11   ns
            16  STORE_FAST           2   (t)                                                        // 11   ns
// >>> if isinstance(t, Extensibility.TRAIT_4):
210         18  LOAD_GLOBAL          4   (isinstance)                                               // 11   ns
            20  LOAD_FAST            2   (t)                                                        // 10   ns
            22  LOAD_GLOBAL          0   (Extensibility)                                            // 11   ns
            24  LOAD_ATTR            5   (TRAIT_4)                                                  // 11   ns
            26  CALL_FUNCTION        2   ()                                                         // 11   ns
            28  POP_JUMP_IF_FALSE    19  (to 38)                                                    // 11   ns
// >>> has_trait = True
211         30  LOAD_CONST           2   (True)                                                     // 11   ns
            32  STORE_FAST           1   (has_trait)                                                // 11   ns
// >>> break
212         34  POP_TOP                  ()                                                         // 11   ns
            36  JUMP_FORWARD         1   (to 40)                                                    // 11   ns
// >>> assert has_trait
213     >>  40  LOAD_FAST            1   (has_trait)                                                // 11   ns
            42  POP_JUMP_IF_TRUE     24  (to 48)                                                    // 11   ns
        >>  48  LOAD_CONST           3   (None)                                                     // 11   ns
            50  RETURN_VALUE             ()                                                         // 23   ns
// =============================================
    \end{minted}
    \caption{Bytecode profile trace of the optimised implementation of \mintinline{python}{has_trait}.}
    \label{listing:bytecode-profiles-hastrait-optimised}
\end{code}










\vspace{2em}
\begin{code}
    \begin{minted}[fontsize=\footnotesize]{text}
//// Trace of `OpCreation.time_operation_create` :

// == microbenchmarks:261 `time_operation_create` ==
// >>> EmptyOp.create()
276         0   LOAD_GLOBAL          0   (EmptyOp)                                                  // 10   ns
            2   LOAD_METHOD          1   (create)                                                   // 12   ns
            4   CALL_METHOD          0   ()                                                         // 46   ns

    // ============= core:942 `create` =============
    // >>> op = cls.__new__(cls)
    953         0   LOAD_FAST            0   (cls)                                                  // 21   ns
                2   LOAD_METHOD          0   (__new__)                                              // 20   ns
                4   LOAD_FAST            0   (cls)                                                  // 19   ns
                6   CALL_METHOD          1   ()                                                     // 22   ns
                8   STORE_FAST           7   (op)                                                   // 18   ns
    // >>> Operation.__init__(
    954         10  LOAD_GLOBAL          1   (Operation)                                            // 16   ns
                12  LOAD_ATTR            2   (__init__)                                             // 18   ns
    // >>> op,
    955         14  LOAD_FAST            7   (op)                                                   // 16   ns
    // >>> operands=operands,
    956         16  LOAD_FAST            1   (operands)                                             // 15   ns
    // >>> result_types=result_types,
    957         18  LOAD_FAST            2   (result_types)                                         // 15   ns
    // >>> properties=properties,
    958         20  LOAD_FAST            3   (properties)                                           // 15   ns
    // >>> attributes=attributes,
    959         22  LOAD_FAST            4   (attributes)                                           // 15   ns
    // >>> successors=successors,
    960         24  LOAD_FAST            5   (successors)                                           // 15   ns
    // >>> regions=regions,
    961         26  LOAD_FAST            6   (regions)                                              // 15   ns
    // >>> Operation.__init__(
    954         28  LOAD_CONST           1   (('operands', 'result_types', 'properties', 'attributes', 'successors', 'regions'))  // 16   ns
                30  CALL_FUNCTION_KW     7   ()                                                     // 54   ns

        // ============ core:914 `__init__` ============
        // >>> super().__init__()
        924         0   LOAD_GLOBAL          0   (super)                                            // 23   ns
                    2   CALL_FUNCTION        0   ()                                                 // 26   ns
                    4   LOAD_METHOD          1   (__init__)                                         // 26   ns
                    6   CALL_METHOD          0   ()                                                 // 25   ns
                    8   POP_TOP                  ()                                                 // 22   ns
        // >>> self.operands = operands
        927         10  LOAD_FAST            1   (operands)                                         // 21   ns
                    12  LOAD_DEREF           0   (self)                                             // 21   ns
                    14  STORE_ATTR           2   (operands)                                         // 44   ns

            // ============ core:888 `operands` ============
            // >>> new = tuple(new)
            890         0   LOAD_GLOBAL          0   (tuple)                                        // 19   ns
                        2   LOAD_FAST            1   (new)                                          // 18   ns
                        4   CALL_FUNCTION        1   ()                                             // 20   ns
                        6   STORE_FAST           1   (new)                                          // 18   ns
            // >>> for idx, operand in enumerate(self._operands):
            891         8   LOAD_GLOBAL          1   (enumerate)                                    // 17   ns
                        10  LOAD_FAST            0   (self)                                         // 17   ns
                        12  LOAD_ATTR            2   (_operands)                                    // 18   ns
                        14  CALL_FUNCTION        1   ()                                             // 20   ns
                        16  GET_ITER                 ()                                             // 18   ns
                    >>  18  FOR_ITER             12  (to 44)                                        // 19   ns
            // >>> for idx, operand in enumerate(new):
            893     >>  44  LOAD_GLOBAL          1   (enumerate)                                    // 17   ns
                        46  LOAD_FAST            1   (new)                                          // 18   ns
                        48  CALL_FUNCTION        1   ()                                             // 20   ns
                        50  GET_ITER                 ()                                             // 18   ns
                    >>  52  FOR_ITER             12  (to 78)                                        // 19   ns
            // >>> self._operands = new
            895     >>  78  LOAD_FAST            1   (new)                                          // 17   ns
                        80  LOAD_FAST            0   (self)                                         // 17   ns
                        82  STORE_ATTR           2   (_operands)                                    // 19   ns
                        84  LOAD_CONST           0   (None)                                         // 17   ns
                        86  RETURN_VALUE             ()                                             // 42   ns
            // =============================================

        // >>> self.results = tuple(
        929         16  LOAD_GLOBAL          3   (tuple)                                            // 22   ns
                    18  LOAD_CLOSURE         0   (self)                                             // 22   ns
                    20  BUILD_TUPLE          1   ()                                                 // 22   ns
                    22  LOAD_CONST           1   (<code object <genexpr> at 0x7a192e602b80, file "/home/ubuntu/Desktop/xdsl/xdsl/ir/core.py", line 929>)  // 22   ns
                    24  LOAD_CONST           2   ('Operation.__init__.<locals>.<genexpr>')          // 21   ns
                    26  MAKE_FUNCTION        8   (closure)                                          // 24   ns
        // >>> for (idx, result_type) in enumerate(result_types)
        931         28  LOAD_GLOBAL          4   (enumerate)                                        // 22   ns
                    30  LOAD_FAST            2   (result_types)                                     // 21   ns
                    32  CALL_FUNCTION        1   ()                                                 // 25   ns
        // >>> self.results = tuple(
        929         34  GET_ITER                 ()                                                 // 22   ns
                    36  CALL_FUNCTION        1   ()                                                 // 25   ns
                    38  CALL_FUNCTION        1   ()                                                 // 46   ns

            // =========== core:929 `<genexpr>` ============
                        0   GEN_START            0   ()                                             // 19   ns
            // >>> self.results = tuple(
            929         2   LOAD_FAST            0   (.0)                                           // 19   ns
                    >>  4   FOR_ITER             11  (to 28)                                        // 20   ns
                    >>  28  LOAD_CONST           0   (None)                                         // 19   ns
                        30  RETURN_VALUE             ()                                             // 47   ns
            // =============================================

                    40  LOAD_DEREF           0   (self)                                             // 22   ns
                    42  STORE_ATTR           5   (results)                                          // 24   ns
        // >>> self.properties = dict(properties)
        933         44  LOAD_GLOBAL          6   (dict)                                             // 22   ns
                    46  LOAD_FAST            3   (properties)                                       // 21   ns
                    48  CALL_FUNCTION        1   ()                                                 // 24   ns
                    50  LOAD_DEREF           0   (self)                                             // 22   ns
                    52  STORE_ATTR           7   (properties)                                       // 23   ns
        // >>> self.attributes = dict(attributes)
        934         54  LOAD_GLOBAL          6   (dict)                                             // 21   ns
                    56  LOAD_FAST            4   (attributes)                                       // 21   ns
                    58  CALL_FUNCTION        1   ()                                                 // 23   ns
                    60  LOAD_DEREF           0   (self)                                             // 21   ns
                    62  STORE_ATTR           8   (attributes)                                       // 23   ns
        // >>> self.successors = list(successors)
        935         64  LOAD_GLOBAL          9   (list)                                             // 21   ns
                    66  LOAD_FAST            5   (successors)                                       // 21   ns
                    68  CALL_FUNCTION        1   ()                                                 // 23   ns
                    70  LOAD_DEREF           0   (self)                                             // 22   ns
                    72  STORE_ATTR           10  (successors)                                       // 43   ns

            // =========== core:901 `successors` ===========
            // >>> new = tuple(new)
            903         0   LOAD_GLOBAL          0   (tuple)                                        // 19   ns
                        2   LOAD_FAST            1   (new)                                          // 19   ns
                        4   CALL_FUNCTION        1   ()                                             // 20   ns
                        6   STORE_FAST           1   (new)                                          // 18   ns
            // >>> for idx, successor in enumerate(self._successors):
            904         8   LOAD_GLOBAL          1   (enumerate)                                    // 17   ns
                        10  LOAD_FAST            0   (self)                                         // 17   ns
                        12  LOAD_ATTR            2   (_successors)                                  // 18   ns
                        14  CALL_FUNCTION        1   ()                                             // 20   ns
                        16  GET_ITER                 ()                                             // 18   ns
                    >>  18  FOR_ITER             12  (to 44)                                        // 19   ns
            // >>> for idx, successor in enumerate(new):
            906     >>  44  LOAD_GLOBAL          1   (enumerate)                                    // 18   ns
                        46  LOAD_FAST            1   (new)                                          // 18   ns
                        48  CALL_FUNCTION        1   ()                                             // 20   ns
                        50  GET_ITER                 ()                                             // 18   ns
                    >>  52  FOR_ITER             12  (to 78)                                        // 19   ns
            // >>> self._successors = new
            908     >>  78  LOAD_FAST            1   (new)                                          // 18   ns
                        80  LOAD_FAST            0   (self)                                         // 17   ns
                        82  STORE_ATTR           2   (_successors)                                  // 19   ns
                        84  LOAD_CONST           0   (None)                                         // 17   ns
                        86  RETURN_VALUE             ()                                             // 42   ns
            // =============================================

        // >>> self.regions = ()
        936         74  LOAD_CONST           3   (())                                               // 22   ns
                    76  LOAD_DEREF           0   (self)                                             // 22   ns
                    78  STORE_ATTR           11  (regions)                                          // 25   ns
        // >>> for region in regions:
        937         80  LOAD_FAST            6   (regions)                                          // 22   ns
                    82  GET_ITER                 ()                                                 // 23   ns
                >>  84  FOR_ITER             7   (to 100)                                           // 22   ns
        // >>> self.__post_init__()
        940     >>  100 LOAD_DEREF           0   (self)                                             // 21   ns
                    102 LOAD_METHOD          13  (__post_init__)                                    // 22   ns
                    104 CALL_METHOD          0   ()                                                 // 57   ns

            // ====== operations:138 `__post_init__` =======
            // >>> op_def = self.get_irdl_definition()
            139         0   LOAD_FAST            0   (self)                                         // 29   ns
                        2   LOAD_METHOD          0   (get_irdl_definition)                          // 31   ns
                        4   CALL_METHOD          0   ()                                             // 36   ns

                // === operations:2004 `get_irdl_definition` ===
                // >>> return op_def
                2006         0   LOAD_DEREF           0   (op_def)                                  // 12   ns
                            2   RETURN_VALUE             ()                                         // 36   ns
                // =============================================

                        6   STORE_FAST           1   (op_def)                                       // 27   ns
            // >>> for prop_name, prop_def in op_def.properties.items():
            141         8   LOAD_FAST            1   (op_def)                                       // 26   ns
                        10  LOAD_ATTR            1   (properties)                                   // 26   ns
                        12  LOAD_METHOD          2   (items)                                        // 26   ns
                        14  CALL_METHOD          0   ()                                             // 28   ns
                        16  GET_ITER                 ()                                             // 28   ns
                    >>  18  FOR_ITER             25  (to 70)                                        // 27   ns
            // >>> for attr_name, attr_def in op_def.attributes.items():
            150     >>  70  LOAD_FAST            1   (op_def)                                       // 25   ns
                        72  LOAD_ATTR            6   (attributes)                                   // 25   ns
                        74  LOAD_METHOD          2   (items)                                        // 25   ns
                        76  CALL_METHOD          0   ()                                             // 27   ns
                        78  GET_ITER                 ()                                             // 27   ns
                    >>  80  FOR_ITER             25  (to 132)                                       // 27   ns
            // >>> return super().__post_init__()
            158     >>  132 LOAD_GLOBAL          7   (super)                                        // 26   ns
                        134 CALL_FUNCTION        0   ()                                             // 29   ns
                        136 LOAD_METHOD          8   (__post_init__)                                // 29   ns
                        138 CALL_METHOD          0   ()                                             // 34   ns

                // ======== builder:343 `new_post_init` ========
                // >>> old_post_init(self)
                344         0   LOAD_DEREF           0   (old_post_init)                            // 12   ns
                            2   LOAD_FAST            0   (self)                                     // 12   ns
                            4   CALL_FUNCTION        1   ()                                         // 25   ns

                    // ========= core:910 `__post_init__` ==========
                    // >>> assert self.name != ""
                    911         0   LOAD_FAST            0   (self)                                 // 11   ns
                                2   LOAD_ATTR            0   (name)                                 // 11   ns
                                4   LOAD_CONST           1   ('')                                   // 10   ns
                                6   COMPARE_OP           3   (!=)                                   // 10   ns
                                8   POP_JUMP_IF_TRUE     7   (to 14)                                // 10   ns
                    // >>> assert isinstance(self.name, str)
                    912     >>  14  LOAD_GLOBAL          1   (isinstance)                           // 10   ns
                                16  LOAD_FAST            0   (self)                                 // 10   ns
                                18  LOAD_ATTR            0   (name)                                 // 11   ns
                                20  LOAD_GLOBAL          2   (str)                                  // 10   ns
                                22  CALL_FUNCTION        2   ()                                     // 11   ns
                                24  POP_JUMP_IF_TRUE     15  (to 30)                                // 10   ns
                            >>  30  LOAD_CONST           0   (None)                                 // 10   ns
                                32  RETURN_VALUE             ()                                     // 24   ns
                    // =============================================

                            6   POP_TOP                  ()                                         // 13   ns
                // >>> _op_init_callback(self)
                345         8   LOAD_GLOBAL          0   (_op_init_callback)                        // 12   ns
                            10  LOAD_FAST            0   (self)                                     // 12   ns
                            12  CALL_FUNCTION        1   ()                                         // 31   ns

                    // ====== builder:335 `_op_init_callback` ======
                    // >>> if (b := ImplicitBuilder.get()) is not None:
                    336         0   LOAD_GLOBAL          0   (ImplicitBuilder)                      // 14   ns
                                2   LOAD_METHOD          1   (get)                                  // 16   ns
                                4   CALL_METHOD          0   ()                                     // 26   ns

                        // ============= builder:321 `get` =============
                        // >>> return cls._stack.get()
                        326         0   LOAD_FAST            0   (cls)                              // 10   ns
                                    2   LOAD_ATTR            0   (_stack)                           // 11   ns
                                    4   LOAD_METHOD          1   (get)                              // 14   ns
                                    6   CALL_METHOD          0   ()                                 // 23   ns

                            // ============= builder:261 `get` =============
                            // >>> if len(self.stack):
                            262         0   LOAD_GLOBAL          0   (len)                          // 10   ns
                                        2   LOAD_FAST            0   (self)                         // 10   ns
                                        4   LOAD_ATTR            1   (stack)                        // 13   ns
                                        6   CALL_FUNCTION        1   ()                             // 12   ns
                                        8   POP_JUMP_IF_FALSE    10  (to 20)                        // 11   ns
                            262     >>  20  LOAD_CONST           0   (None)                         // 10   ns
                                        22  RETURN_VALUE             ()                             // 23   ns
                            // =============================================

                                    8   RETURN_VALUE             ()                                 // 25   ns
                        // =============================================

                                6   DUP_TOP                  ()                                     // 14   ns
                                8   STORE_FAST           1   (b)                                    // 13   ns
                                10  LOAD_CONST           0   (None)                                 // 11   ns
                                12  IS_OP                1   ()                                     // 12   ns
                                14  POP_JUMP_IF_FALSE    15  (to 30)                                // 12   ns
                    336     >>  30  LOAD_CONST           0   (None)                                 // 11   ns
                                32  RETURN_VALUE             ()                                     // 26   ns
                    // =============================================

                            14  POP_TOP                  ()                                         // 12   ns
                            16  LOAD_CONST           0   (None)                                     // 12   ns
                            18  RETURN_VALUE             ()                                         // 36   ns
                // =============================================

                        140 RETURN_VALUE             ()                                             // 54   ns
            // =============================================

                    106 POP_TOP                  ()                                                 // 22   ns
                    108 LOAD_CONST           0   (None)                                             // 22   ns
                    110 RETURN_VALUE             ()                                                 // 47   ns
        // =============================================

                32  POP_TOP                  ()                                                     // 17   ns
    // >>> return op
    963         34  LOAD_FAST            7   (op)                                                   // 17   ns
                36  RETURN_VALUE             ()                                                     // 35   ns
    // =============================================

            6   POP_TOP                  ()                                                         // 15   ns
            8   LOAD_CONST           1   (None)                                                     // 10   ns
            10  RETURN_VALUE             ()                                                         // 24   ns
// =============================================
    \end{minted}
    \caption{Bytecode profile trace of the original implementation of instantiation of an empty operation.}
    \label{listing:bytecode-profiles-hastrait-original}
\end{code}

\vspace{2em}
\begin{code}
    \begin{minted}[fontsize=\footnotesize]{text}
//// Trace of `OpCreation.time_operation_create_optimised` :

// == microbenchmarks:297 `time_operation_create_optimised` ==
// >>> empty_op = EmptyOp.__new__(EmptyOp)
299         0   LOAD_GLOBAL          0   (EmptyOp)                                                  // 23   ns
            2   LOAD_METHOD          1   (__new__)                                                  // 24   ns
            4   LOAD_GLOBAL          0   (EmptyOp)                                                  // 22   ns
            6   CALL_METHOD          1   ()                                                         // 26   ns
            8   STORE_FAST           1   (empty_op)                                                 // 20   ns
// >>> empty_op._operands = tuple()  # pyright: ignore[reportPrivateUsage]
300         10  LOAD_GLOBAL          2   (tuple)                                                    // 19   ns
            12  CALL_FUNCTION        0   ()                                                         // 20   ns
            14  LOAD_FAST            1   (empty_op)                                                 // 19   ns
            16  STORE_ATTR           3   (_operands)                                                // 22   ns
// >>> empty_op.results = tuple()
301         18  LOAD_GLOBAL          2   (tuple)                                                    // 19   ns
            20  CALL_FUNCTION        0   ()                                                         // 20   ns
            22  LOAD_FAST            1   (empty_op)                                                 // 18   ns
            24  STORE_ATTR           4   (results)                                                  // 21   ns
// >>> empty_op.properties = {}
302         26  BUILD_MAP            0   ()                                                         // 19   ns
            28  LOAD_FAST            1   (empty_op)                                                 // 17   ns
            30  STORE_ATTR           5   (properties)                                               // 21   ns
// >>> empty_op.attributes = {}
303         32  BUILD_MAP            0   ()                                                         // 19   ns
            34  LOAD_FAST            1   (empty_op)                                                 // 18   ns
            36  STORE_ATTR           6   (attributes)                                               // 22   ns
// >>> empty_op._successors = tuple()  # pyright: ignore[reportPrivateUsage]
304         38  LOAD_GLOBAL          2   (tuple)                                                    // 18   ns
            40  CALL_FUNCTION        0   ()                                                         // 20   ns
            42  LOAD_FAST            1   (empty_op)                                                 // 18   ns
            44  STORE_ATTR           7   (_successors)                                              // 21   ns
// >>> empty_op.regions = tuple()
305         46  LOAD_GLOBAL          2   (tuple)                                                    // 18   ns
            48  CALL_FUNCTION        0   ()                                                         // 20   ns
            50  LOAD_FAST            1   (empty_op)                                                 // 19   ns
            52  STORE_ATTR           8   (regions)                                                  // 23   ns
            54  LOAD_CONST           1   (None)                                                     // 18   ns
            56  RETURN_VALUE             ()                                                         // 44   ns
// =============================================
    \end{minted}
    \caption{Bytecode profile trace of the optimised implementation of instantiation an empty operation.}
    \label{listing:bytecode-profiles-hastrait-optimised}
\end{code}


% \vspace{2em}
% \begin{code}
%     \begin{minted}[fontsize=\footnotesize]{text}
%     \end{minted}
%     \caption{Bytecode profile trace of...}
%     \label{listing:bytecode-profiles-...}
% \end{code}

%% Pattern rewriting on Desktop
