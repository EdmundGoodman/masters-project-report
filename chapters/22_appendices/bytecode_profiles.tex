\chapter{Bytecode profiles}
\label{chap:bytecode-profiles}

\begin{code}
    \begin{minted}[fontsize=\footnotesize]{text}
//// Trace of `Extensibility.time_trait_check` :

// == microbenchmarks:176 `time_trait_check` ===
// >>> assert Extensibility.OP_WITH_REGION.has_trait(Extensibility.TRAIT_4)
204         0   LOAD_GLOBAL          0   (Extensibility)                                            // 17   ns
            2   LOAD_ATTR            1   (OP_WITH_REGION)                                           // 18   ns
            4   LOAD_METHOD          2   (has_trait)                                                // 18   ns
            6   LOAD_GLOBAL          0   (Extensibility)                                            // 17   ns
            8   LOAD_ATTR            3   (TRAIT_4)                                                  // 18   ns
            10  CALL_METHOD          1   ()                                                         // 54   ns

    // =========== core:1192 `has_trait` ===========
    // >>> from xdsl.dialects.builtin import UnregisteredOp
    1204         0   LOAD_CONST           1   (0)                                                   // 26   ns
                2   LOAD_CONST           2   (('UnregisteredOp',))                                  // 25   ns
                4   IMPORT_NAME          0   (xdsl.dialects.builtin)                                // 72   ns
                6   IMPORT_FROM          1   (UnregisteredOp)                                       // 28   ns
                8   STORE_FAST           3   (UnregisteredOp)                                       // 23   ns
                10  POP_TOP                  ()                                                     // 21   ns
    // >>> if issubclass(cls, UnregisteredOp):
    1206         12  LOAD_GLOBAL          2   (issubclass)                                          // 21   ns
                14  LOAD_FAST            0   (cls)                                                  // 21   ns
                16  LOAD_FAST            3   (UnregisteredOp)                                       // 19   ns
                18  CALL_FUNCTION        2   ()                                                     // 46   ns

        // ======== abc:121 `__subclasscheck__` ========
        // >>> return _abc_subclasscheck(cls, subclass)
        123         0   LOAD_GLOBAL          0   (_abc_subclasscheck)                               // 19   ns
                    2   LOAD_FAST            0   (cls)                                              // 18   ns
                    4   LOAD_FAST            1   (subclass)                                         // 17   ns
                    6   CALL_FUNCTION        2   ()                                                 // 26   ns
                    8   RETURN_VALUE             ()                                                 // 44   ns
        // =============================================

                20  POP_JUMP_IF_FALSE    13  (to 26)                                                // 22   ns
    // >>> return cls.get_trait(trait) is not None
    1209     >>  26  LOAD_FAST            0   (cls)                                                 // 21   ns
                28  LOAD_METHOD          3   (get_trait)                                            // 23   ns
                30  LOAD_FAST            1   (trait)                                                // 21   ns
                32  CALL_METHOD          1   ()                                                     // 52   ns

        // =========== core:1211 `get_trait` ===========
        // >>> if isinstance(trait, type):
        1216         0   LOAD_GLOBAL          0   (isinstance)                                      // 24   ns
                    2   LOAD_FAST            1   (trait)                                            // 23   ns
                    4   LOAD_GLOBAL          1   (type)                                             // 25   ns
                    6   CALL_FUNCTION        2   ()                                                 // 25   ns
                    8   POP_JUMP_IF_FALSE    27  (to 54)                                            // 23   ns
        // >>> for t in cls.traits:
        1217         10  LOAD_FAST            0   (cls)                                             // 22   ns
                    12  LOAD_ATTR            2   (traits)                                           // 24   ns
                    14  GET_ITER                 ()                                                 // 43   ns

            // ============ core:758 `__iter__` ============
            // >>> return iter(self.traits)
            759         0   LOAD_GLOBAL          0   (iter)                                         // 17   ns
                        2   LOAD_FAST            0   (self)                                         // 16   ns
                        4   LOAD_ATTR            1   (traits)                                       // 38   ns

                // ============= core:747 `traits` =============
                // >>> if callable(self._traits):
                750         0   LOAD_GLOBAL          0   (callable)                                 // 17   ns
                            2   LOAD_FAST            0   (self)                                     // 15   ns
                            4   LOAD_ATTR            1   (_traits)                                  // 17   ns
                            6   CALL_FUNCTION        1   ()                                         // 18   ns
                            8   POP_JUMP_IF_FALSE    12  (to 24)                                    // 17   ns
                // >>> return self._traits
                752     >>  24  LOAD_FAST            0   (self)                                     // 16   ns
                            26  LOAD_ATTR            1   (_traits)                                  // 16   ns
                            28  RETURN_VALUE             ()                                         // 38   ns
                // =============================================

                        6   CALL_FUNCTION        1   ()                                             // 22   ns
                        8   RETURN_VALUE             ()                                             // 42   ns
            // =============================================

                >>  16  FOR_ITER             16  (to 50)                                            // 25   ns
                    18  STORE_FAST           2   (t)                                                // 22   ns
        // >>> if isinstance(t, cast(type[OpTraitInvT], trait)):
        1218         20  LOAD_GLOBAL          0   (isinstance)                                      // 21   ns
                    22  LOAD_FAST            2   (t)                                                // 21   ns
                    24  LOAD_GLOBAL          3   (cast)                                             // 21   ns
                    26  LOAD_GLOBAL          1   (type)                                             // 19   ns
                    28  LOAD_GLOBAL          4   (OpTraitInvT)                                      // 18   ns
                    30  BINARY_SUBSCR            ()                                                 // 22   ns
                    32  LOAD_FAST            1   (trait)                                            // 19   ns
                    34  CALL_FUNCTION        2   ()                                                 // 41   ns

            // ============ typing:1737 `cast` =============
            // >>> return val
            1745         0   LOAD_FAST            1   (val)                                         // 18   ns
                        2   RETURN_VALUE             ()                                             // 43   ns
            // =============================================

                    36  CALL_FUNCTION        2   ()                                                 // 23   ns
                    38  POP_JUMP_IF_FALSE    24  (to 48)                                            // 20   ns
        1218     >>  48  JUMP_ABSOLUTE        8   (to 16)                                           // 20   ns
        // >>> for t in cls.traits:
                >>  16  FOR_ITER             16  (to 50)                                            // 19   ns
                    18  STORE_FAST           2   (t)                                                // 19   ns
        // >>> if isinstance(t, cast(type[OpTraitInvT], trait)):
        1218         20  LOAD_GLOBAL          0   (isinstance)                                      // 19   ns
                    22  LOAD_FAST            2   (t)                                                // 19   ns
                    24  LOAD_GLOBAL          3   (cast)                                             // 19   ns
                    26  LOAD_GLOBAL          1   (type)                                             // 18   ns
                    28  LOAD_GLOBAL          4   (OpTraitInvT)                                      // 18   ns
                    30  BINARY_SUBSCR            ()                                                 // 21   ns
                    32  LOAD_FAST            1   (trait)                                            // 19   ns
                    34  CALL_FUNCTION        2   ()                                                 // 40   ns

            // ============ typing:1737 `cast` =============
            // >>> return val
            1745         0   LOAD_FAST            1   (val)                                         // 18   ns
                        2   RETURN_VALUE             ()                                             // 43   ns
            // =============================================

                    36  CALL_FUNCTION        2   ()                                                 // 21   ns
                    38  POP_JUMP_IF_FALSE    24  (to 48)                                            // 20   ns
        // >>> return t
        1219         40  LOAD_FAST            2   (t)                                               // 19   ns
                    42  ROT_TWO                  ()                                                 // 19   ns
                    44  POP_TOP                  ()                                                 // 20   ns
                    46  RETURN_VALUE             ()                                                 // 47   ns
        // =============================================

                34  LOAD_CONST           3   (None)                                                 // 21   ns
                36  IS_OP                1   ()                                                     // 21   ns
                38  RETURN_VALUE             ()                                                     // 47   ns
    // =============================================

            12  POP_JUMP_IF_TRUE     9   (to 18)                                                    // 16   ns
        >>  18  LOAD_CONST           1   (None)                                                     // 16   ns
            20  RETURN_VALUE             ()                                                         // 39   ns
// =============================================
    \end{minted}
    \caption{Bytecode profile trace of the original implementation of \mintinline{python}{has_trait}.}
    \label{listing:bytecode-profiles-hastrait-original}
\end{code}

\vspace{2em}

\begin{code}
    \begin{minted}[fontsize=\footnotesize]{text}
//// Trace of `Extensibility.time_trait_check_optimised` :

// == microbenchmarks:206 `time_trait_check_optimised` ==
// >>> has_trait = False
208         0   LOAD_CONST           1   (False)                                                    // 14   ns
            2   STORE_FAST           1   (has_trait)                                                // 14   ns
// >>> for t in Extensibility.OP_WITH_REGION.traits._traits:
209         4   LOAD_GLOBAL          0   (Extensibility)                                            // 13   ns
            6   LOAD_ATTR            1   (OP_WITH_REGION)                                           // 13   ns
            8   LOAD_ATTR            2   (traits)                                                   // 13   ns
            10  LOAD_ATTR            3   (_traits)                                                  // 13   ns
            12  GET_ITER                 ()                                                         // 13   ns
        >>  14  FOR_ITER             12  (to 40)                                                    // 13   ns
            16  STORE_FAST           2   (t)                                                        // 11   ns
// >>> if isinstance(t, Extensibility.TRAIT_4):
210         18  LOAD_GLOBAL          4   (isinstance)                                               // 11   ns
            20  LOAD_FAST            2   (t)                                                        // 11   ns
            22  LOAD_GLOBAL          0   (Extensibility)                                            // 11   ns
            24  LOAD_ATTR            5   (TRAIT_4)                                                  // 11   ns
            26  CALL_FUNCTION        2   ()                                                         // 12   ns
            28  POP_JUMP_IF_FALSE    19  (to 38)                                                    // 11   ns
210     >>  38  JUMP_ABSOLUTE        7   (to 14)                                                    // 11   ns
// >>> for t in Extensibility.OP_WITH_REGION.traits._traits:
        >>  14  FOR_ITER             12  (to 40)                                                    // 11   ns
            16  STORE_FAST           2   (t)                                                        // 11   ns
// >>> if isinstance(t, Extensibility.TRAIT_4):
210         18  LOAD_GLOBAL          4   (isinstance)                                               // 11   ns
            20  LOAD_FAST            2   (t)                                                        // 10   ns
            22  LOAD_GLOBAL          0   (Extensibility)                                            // 11   ns
            24  LOAD_ATTR            5   (TRAIT_4)                                                  // 11   ns
            26  CALL_FUNCTION        2   ()                                                         // 11   ns
            28  POP_JUMP_IF_FALSE    19  (to 38)                                                    // 11   ns
// >>> has_trait = True
211         30  LOAD_CONST           2   (True)                                                     // 11   ns
            32  STORE_FAST           1   (has_trait)                                                // 11   ns
// >>> break
212         34  POP_TOP                  ()                                                         // 11   ns
            36  JUMP_FORWARD         1   (to 40)                                                    // 11   ns
// >>> assert has_trait
213     >>  40  LOAD_FAST            1   (has_trait)                                                // 11   ns
            42  POP_JUMP_IF_TRUE     24  (to 48)                                                    // 11   ns
        >>  48  LOAD_CONST           3   (None)                                                     // 11   ns
            50  RETURN_VALUE             ()                                                         // 23   ns
// =============================================
    \end{minted}
    \caption{Bytecode profile trace of the optimised implementation of \mintinline{python}{has_trait}.}
    \label{listing:bytecode-profiles-hastrait-optimised}
\end{code}
